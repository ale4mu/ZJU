df = df2 #不妨选df2作为接下来分析的对象
# 查看修改后smoke和drunk的结果
table(df$smoke, useNA = "always")
table(df$drunk, useNA = "always")
options(htmltools.dir.version = FALSE)
library(knitr)
opts_knit$set(eval.after = 'fig.cap')
library(tidyverse)
library(reshape2)
library(ggplot2)
library(readxl)
library(dplyr)
library(readr)
library(mice)
library(Hmisc)
library(naniar)
library(showtext)
showtext_auto()
clean <- function(df){
df <- df[-1, ]  # 删除中文描述的行
#print(str(df)) # 查看每列的类型
# 要转换成数值格式的列
numeric_cols <- c("age", "sbp", "dbp", "weight", "height", "FPG", "TG", "HDL-C")
df <- df |>
mutate(
across(all_of(numeric_cols), parse_number)
)
# 观察到smoke列有多种回答
df <- df %>%
mutate(
smoke = case_when(
smoke == "是" ~ "是",
smoke %in% c("否", "已戒烟", "戒烟3年", "戒烟2个月") ~ "否",
TRUE ~ NA_character_
) %>%
factor(levels = c("否", "是"))
)
# 同样，drunk列有“是”“否”“无”三种回答
df <- df %>%
mutate(
drunk = case_when(
drunk == "是" ~ "是",
drunk %in% c("否", "无") ~ "否",
TRUE ~ NA_character_
) %>%
factor(levels = c("否", "是"))
)
#df <- na.omit(df) # 删除含有缺失值的行
df <- df %>% filter(!is.na(gender))
meth <- rep("pmm", ncol(df))
names(meth) <- names(df)  # 把列名赋给 meth
meth["smoke"] <- "logreg"
meth["drunk"] <- "logreg"
df <- mice(df, m = 10, maxit = 50, method =meth, printFlag = FALSE,seed=42) #多重插补
df <- complete(df, 1) #选取第一个
#print(nrow(df)) # 打印剩下的行数
print("验证缺失值：")
print(colSums(is.na(df))) # 验证是否还存在缺失值
print("每列的类型：")
print(str(df)) # 再次查看每列的类型
return(df)
}
df2 <- read_excel("sample.xls",sheet = "Sheet2")
df2 <- clean(df2) # 处理Sheet2
df = df2 #不妨选df2作为接下来分析的对象
# 查看修改后smoke和drunk的结果
table(df$smoke, useNA = "always")
table(df$drunk, useNA = "always")
diagnose(df)
print(df$loggedEvents)
clean <- function(df){
df <- df[-1, ]  # 删除中文描述的行
#print(str(df)) # 查看每列的类型
# 要转换成数值格式的列
numeric_cols <- c("age", "sbp", "dbp", "weight", "height", "FPG", "TG", "HDL-C")
df <- df |>
mutate(
across(all_of(numeric_cols), parse_number)
)
# 观察到smoke列有多种回答
df <- df %>%
mutate(
smoke = case_when(
smoke == "是" ~ "是",
smoke %in% c("否", "已戒烟", "戒烟3年", "戒烟2个月") ~ "否",
TRUE ~ NA_character_
) %>%
factor(levels = c("否", "是"))
)
# 同样，drunk列有“是”“否”“无”三种回答
df <- df %>%
mutate(
drunk = case_when(
drunk == "是" ~ "是",
drunk %in% c("否", "无") ~ "否",
TRUE ~ NA_character_
) %>%
factor(levels = c("否", "是"))
)
#df <- na.omit(df) # 删除含有缺失值的行
df <- df %>% filter(!is.na(gender))
meth <- rep("pmm", ncol(df))
names(meth) <- names(df)  # 把列名赋给 meth
meth["smoke"] <- "logreg"
meth["drunk"] <- "logreg"
df <- mice(df, m = 10, maxit = 50, method =meth, printFlag = FALSE,seed=42) #多重插补
print(df$loggedEvents)
df <- complete(df, 1) #选取第一个
#print(nrow(df)) # 打印剩下的行数
print("验证缺失值：")
print(colSums(is.na(df))) # 验证是否还存在缺失值
print("每列的类型：")
print(str(df)) # 再次查看每列的类型
return(df)
}
df2 <- read_excel("sample.xls",sheet = "Sheet2")
df2 <- clean(df2) # 处理Sheet2
df = df2 #不妨选df2作为接下来分析的对象
# 查看修改后smoke和drunk的结果
table(df$smoke, useNA = "always")
table(df$drunk, useNA = "always")
options(htmltools.dir.version = FALSE)
library(knitr)
opts_knit$set(eval.after = 'fig.cap')
library(tidyverse)
library(reshape2)
library(ggplot2)
library(readxl)
library(dplyr)
library(readr)
library(mice)
library(Hmisc)
library(naniar)
library(showtext)
showtext_auto()
options(warn = -1)
clean <- function(df){
df <- df[-1, ]  # 删除中文描述的行
#print(str(df)) # 查看每列的类型
# 要转换成数值格式的列
numeric_cols <- c("age", "sbp", "dbp", "weight", "height", "FPG", "TG", "HDL-C")
df <- df |>
mutate(
across(all_of(numeric_cols), parse_number)
)
# 观察到smoke列有多种回答
df <- df %>%
mutate(
smoke = case_when(
smoke == "是" ~ "是",
smoke %in% c("否", "已戒烟", "戒烟3年", "戒烟2个月") ~ "否",
TRUE ~ NA_character_
) %>%
factor(levels = c("否", "是"))
)
# 同样，drunk列有“是”“否”“无”三种回答
df <- df %>%
mutate(
drunk = case_when(
drunk == "是" ~ "是",
drunk %in% c("否", "无") ~ "否",
TRUE ~ NA_character_
) %>%
factor(levels = c("否", "是"))
)
#df <- na.omit(df) # 删除含有缺失值的行
df <- df %>% filter(!is.na(gender))
meth <- rep("pmm", ncol(df))
names(meth) <- names(df)  # 把列名赋给 meth
meth["smoke"] <- "logreg"
meth["drunk"] <- "logreg"
df <- mice(df, m = 10, maxit = 50, method =meth, printFlag = FALSE,seed=42) #多重插补
df <- complete(df, 1) #选取第一个
#print(nrow(df)) # 打印剩下的行数
print("验证缺失值：")
print(colSums(is.na(df))) # 验证是否还存在缺失值
print("每列的类型：")
print(str(df)) # 再次查看每列的类型
return(df)
}
df2 <- read_excel("sample.xls",sheet = "Sheet2")
df2 <- clean(df2) # 处理Sheet2
df = df2 #不妨选df2作为接下来分析的对象
# 查看修改后smoke和drunk的结果
table(df$smoke, useNA = "always")
table(df$drunk, useNA = "always")
options(htmltools.dir.version = FALSE)
library(knitr)
opts_knit$set(eval.after = 'fig.cap')
library(tidyverse)
library(reshape2)
library(ggplot2)
library(readxl)
library(dplyr)
library(readr)
library(mice)
library(Hmisc)
library(naniar)
library(showtext)
showtext_auto()
clean <- function(df){
df <- df[-1, ]  # 删除中文描述的行
#print(str(df)) # 查看每列的类型
# 要转换成数值格式的列
numeric_cols <- c("age", "sbp", "dbp", "weight", "height", "FPG", "TG", "HDL-C")
df <- df |>
mutate(
across(all_of(numeric_cols), parse_number)
)
# 观察到smoke列有多种回答
df <- df %>%
mutate(
smoke = case_when(
smoke == "是" ~ "是",
smoke %in% c("否", "已戒烟", "戒烟3年", "戒烟2个月") ~ "否",
TRUE ~ NA_character_
) %>%
factor(levels = c("否", "是"))
)
# 同样，drunk列有“是”“否”“无”三种回答
df <- df %>%
mutate(
drunk = case_when(
drunk == "是" ~ "是",
drunk %in% c("否", "无") ~ "否",
TRUE ~ NA_character_
) %>%
factor(levels = c("否", "是"))
)
#df <- na.omit(df) # 删除含有缺失值的行
df <- df %>% filter(!is.na(gender))
meth <- rep("pmm", ncol(df))
names(meth) <- names(df)  # 把列名赋给 meth
meth["smoke"] <- "logreg"
meth["drunk"] <- "logreg"
df <- suppressWarnings(mice(df, m = 10, maxit = 50, method =meth, printFlag = FALSE,seed=42)) #多重插补
df <- complete(df, 1) #选取第一个
#print(nrow(df)) # 打印剩下的行数
print("验证缺失值：")
print(colSums(is.na(df))) # 验证是否还存在缺失值
print("每列的类型：")
print(str(df)) # 再次查看每列的类型
return(df)
}
df2 <- read_excel("sample.xls",sheet = "Sheet2")
df2 <- clean(df2) # 处理Sheet2
df = df2 #不妨选df2作为接下来分析的对象
# 查看修改后smoke和drunk的结果
table(df$smoke, useNA = "always")
table(df$drunk, useNA = "always")
df <- df %>%
mutate(BMI = round(weight / (height / 100)^2, 2)) # BMI = 体重/ （身高的平方）
print(head(df$BMI)) # 打印前几行BMI
numeric_vars <- c("age", "sbp", "dbp", "weight", "height", "FPG", "TG", "HDL-C","BMI")
# 描述性统计分析
df %>%
select(all_of(numeric_vars)) %>%
summary()
max_bmi <- max(df$BMI, na.rm = TRUE)
max_bmi_row <- df[df$BMI == max_bmi, ]
print(max_bmi_row)
# 事实上这里直接选择将50作为BMI的合理阈值
# df <- df[df$BMI <= 50, ]
# df %>%
#   select(all_of(numeric_vars)) %>%
#   summary()
X <- df[, c("BMI", "FPG", "sbp", "dbp", "TG", "HDL-C")]
cor_matrix <- cor(X)
round(cor_matrix, 3)
res <- rcorr(as.matrix(X))
cor_coef <- res$r                 # 相关系数
cor_p <- res$P                    # p 值
print(round(cor_coef, 3))
print(round(cor_p,3))
X <- df[, c("BMI", "FPG", "sbp", "dbp", "TG", "HDL-C")]
cor_matrix <- cor(X)
round(cor_matrix, 3)
res <- rcorr(as.matrix(X))
cor_coef <- res$r                 # 相关系数
cor_p <- res$P                    # p 值
#print(round(cor_coef, 3))
print(round(cor_p,3))
X <- df[, c("BMI", "FPG", "sbp", "dbp", "TG", "HDL-C")]
cor_matrix <- cor(X)
round(cor_matrix, 3)
# res <- rcorr(as.matrix(X))
# cor_coef <- res$r                 # 相关系数
# cor_p <- res$P                    # p 值
#print(round(cor_coef, 3))
#print(round(cor_p,3))
X <- df[, c("BMI", "FPG", "sbp", "dbp", "TG", "HDL-C")]
cor_matrix <- cor(X)
round(cor_matrix, 3)
res <- rcorr(as.matrix(X))
cor_coef <- res$r                 # 相关系数
cor_p <- res$P                    # p 值
#print(round(cor_coef, 3))
print(round(cor_p,3))
df$Overweight <- ifelse(df$BMI >= 25, 1, 0) # 超重
df$Hyperglycemia <- ifelse(df$FPG >= 6.1, 1, 0) # 高血糖
df$HTN <- ifelse(df$sbp >= 140| df$dbp >= 90, 1, 0) # 高血压
df$FBG <- ifelse(df$TG >= 1.7 |
(df$`HDL-C` < 0.9 & df$gender == "男") |
(df$`HDL-C` < 1 & df$gender == "女"), 1, 0) # 空腹血
df$sick <- ifelse(rowSums(cbind(df$Overweight,
df$Hyperglycemia,
df$HTN,
df$FBG)) >= 3, 1, 0) # 是否患代谢综合征，1为患，0为不患
table(df$sick)
table(df$gender, df$sick)
contingency_table <- table(df$gender, df$sick)
chisq_test <- chisq.test(contingency_table) # 卡方检验
#fisher.test(contingency_table)
print(chisq_test)
sick_smoke <- table(df$smoke, df$sick)
print(sick_smoke)
chisq_test <- chisq.test(sick_smoke)
print(chisq_test)
sick_drunk <- table(df$drunk, df$sick)
print(sick_drunk)
chisq_test <- chisq.test(sick_drunk)
print(chisq_test)
sick_drunk <- table(df$drunk, df$sick)
print(sick_drunk)
chisq_test <- chisq.test(sick_drunk)
print(chisq_test)
df0 <- subset(df, age >= 20 & age <= 30)
X <- c("BMI", "FPG", "sbp", "dbp", "TG", "HDL-C")
df_X <- df0[,X]
#summary(df_X)
# 直方图
par(mfrow = c(2, 3))
for (var in X) {
hist(df_X[[var]],
breaks = 11,
main = paste(var),
xlab = var,
col = "skyblue",
border = "navy",
freq = FALSE)
lines(density(df_X[[var]], na.rm = TRUE), col = "red", lwd = 2)
}
par(mfrow = c(1, 1))
# 箱线图
par(mfrow = c(2, 3))
for (var in X) {
boxplot(df_X[[var]], main = var, ylab = var, col = "lightblue", border = "darkgreen")
}
par(mfrow = c(1, 1))
# 密度图
X_long <- df_X %>%
pivot_longer(everything(), names_to = "Variable", values_to = "Value")
ggplot(X_long, aes(x = Value, fill = Variable)) +
geom_density(alpha = 0.6) +
facet_wrap(~ Variable, scales = "free", ncol = 2) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 30))
X <- df[, c("BMI", "FPG", "sbp", "dbp", "TG", "HDL-C")]
mean_vector <- colMeans(X, na.rm = TRUE) #均值向量
cov_matrix <- cov(X, use = "complete.obs") #协方差矩阵
cor_matrix <- cor(X, use = "complete.obs")# 相关矩阵
result <- list(均值向量 = round(mean_vector, 3),协方差矩阵 = cov_matrix,相关矩阵=cor_matrix)
print(result)
options(htmltools.dir.version = FALSE)
library(knitr)
opts_knit$set(eval.after = 'fig.cap')
library(tidyverse)
library(reshape2)
library(ggplot2)
library(readxl)
library(dplyr)
library(readr)
library(mice)
library(Hmisc)
library(naniar)
library(showtext)
showtext_auto()
clean <- function(df){
df <- df[-1, ]  # 删除中文描述的行
#print(str(df)) # 查看每列的类型
# 要转换成数值格式的列
numeric_cols <- c("age", "sbp", "dbp", "weight", "height", "FPG", "TG", "HDL-C")
df <- df |>
mutate(
across(all_of(numeric_cols), parse_number)
)
# 观察到smoke列有多种回答
df <- df %>%
mutate(
smoke = case_when(
smoke == "是" ~ "是",
smoke %in% c("否", "已戒烟", "戒烟3年", "戒烟2个月") ~ "否",
TRUE ~ NA_character_
) %>%
factor(levels = c("否", "是"))
)
# 同样，drunk列有“是”“否”“无”三种回答
df <- df %>%
mutate(
drunk = case_when(
drunk == "是" ~ "是",
drunk %in% c("否", "无") ~ "否",
TRUE ~ NA_character_
) %>%
factor(levels = c("否", "是"))
)
#df <- na.omit(df) # 删除含有缺失值的行
df <- df %>% filter(!is.na(gender))
meth <- rep("pmm", ncol(df))
names(meth) <- names(df)  # 把列名赋给 meth
meth["smoke"] <- "logreg"
meth["drunk"] <- "logreg"
df <- suppressWarnings(mice(df, m = 10, maxit = 50, method =meth, printFlag = FALSE,seed=42)) #多重插补
df <- complete(df, 1) #选取第一个
#print(nrow(df)) # 打印剩下的行数
print("验证缺失值：")
print(colSums(is.na(df))) # 验证是否还存在缺失值
print("每列的类型：")
print(str(df)) # 再次查看每列的类型
return(df)
}
df2 <- read_excel("sample.xls",sheet = "Sheet2")
df2 <- clean(df2) # 处理Sheet2
df = df2 #不妨选df2作为接下来分析的对象
# 查看修改后smoke和drunk的结果
table(df$smoke, useNA = "always")
table(df$drunk, useNA = "always")
df <- df %>%
mutate(BMI = round(weight / (height / 100)^2, 2)) # BMI = 体重/ （身高的平方）
print(head(df$BMI)) # 打印前几行BMI
numeric_vars <- c("age", "sbp", "dbp", "weight", "height", "FPG", "TG", "HDL-C","BMI")
# 描述性统计分析
df %>%
select(all_of(numeric_vars)) %>%
summary()
max_bmi <- max(df$BMI, na.rm = TRUE)
max_bmi_row <- df[df$BMI == max_bmi, ]
print(max_bmi_row)
# 事实上这里直接选择将50作为BMI的合理阈值
df <- df[df$BMI <= 50, ]
# df %>%
#   select(all_of(numeric_vars)) %>%
#   summary()
X <- df[, c("BMI", "FPG", "sbp", "dbp", "TG", "HDL-C")]
cor_matrix <- cor(X)
round(cor_matrix, 3)
res <- rcorr(as.matrix(X))
cor_coef <- res$r                 # 相关系数
cor_p <- res$P                    # p 值
#print(round(cor_coef, 3))
print(round(cor_p,3))
df$Overweight <- ifelse(df$BMI >= 25, 1, 0) # 超重
df$Hyperglycemia <- ifelse(df$FPG >= 6.1, 1, 0) # 高血糖
df$HTN <- ifelse(df$sbp >= 140| df$dbp >= 90, 1, 0) # 高血压
df$FBG <- ifelse(df$TG >= 1.7 |
(df$`HDL-C` < 0.9 & df$gender == "男") |
(df$`HDL-C` < 1 & df$gender == "女"), 1, 0) # 空腹血
df$sick <- ifelse(rowSums(cbind(df$Overweight,
df$Hyperglycemia,
df$HTN,
df$FBG)) >= 3, 1, 0) # 是否患代谢综合征，1为患，0为不患
table(df$sick)
table(df$gender, df$sick)
contingency_table <- table(df$gender, df$sick)
chisq_test <- chisq.test(contingency_table) # 卡方检验
#fisher.test(contingency_table)
print(chisq_test)
sick_smoke <- table(df$smoke, df$sick)
print(sick_smoke)
chisq_test <- chisq.test(sick_smoke)
print(chisq_test)
sick_drunk <- table(df$drunk, df$sick)
print(sick_drunk)
chisq_test <- chisq.test(sick_drunk)
print(chisq_test)
df0 <- subset(df, age >= 20 & age <= 30)
X <- c("BMI", "FPG", "sbp", "dbp", "TG", "HDL-C")
df_X <- df0[,X]
#summary(df_X)
# 直方图
par(mfrow = c(2, 3))
for (var in X) {
hist(df_X[[var]],
breaks = 11,
main = paste(var),
xlab = var,
col = "skyblue",
border = "navy",
freq = FALSE)
lines(density(df_X[[var]], na.rm = TRUE), col = "red", lwd = 2)
}
par(mfrow = c(1, 1))
# 箱线图
par(mfrow = c(2, 3))
for (var in X) {
boxplot(df_X[[var]], main = var, ylab = var, col = "lightblue", border = "darkgreen")
}
par(mfrow = c(1, 1))
# 密度图
X_long <- df_X %>%
pivot_longer(everything(), names_to = "Variable", values_to = "Value")
ggplot(X_long, aes(x = Value, fill = Variable)) +
geom_density(alpha = 0.6) +
facet_wrap(~ Variable, scales = "free", ncol = 2) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 30))
X <- df[, c("BMI", "FPG", "sbp", "dbp", "TG", "HDL-C")]
mean_vector <- colMeans(X, na.rm = TRUE) #均值向量
cov_matrix <- cov(X, use = "complete.obs") #协方差矩阵
cor_matrix <- cor(X, use = "complete.obs")# 相关矩阵
result <- list(均值向量 = round(mean_vector, 3),协方差矩阵 = cov_matrix,相关矩阵=cor_matrix)
print(result)
