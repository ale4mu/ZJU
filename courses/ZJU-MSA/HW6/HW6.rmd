---
title: "Homework 6"
author: "张子乐,3230104237"
output:
  pdf_document:
    latex_engine: xelatex
  html_document:
    df_print: paged
header-includes:
  - \usepackage{ctex}
---
```{r setup, message = F, include=FALSE}
options(htmltools.dir.version = FALSE)
library(knitr)
opts_knit$set(eval.after = 'fig.cap')
library(tidyverse)
library(reshape2)
library(ggplot2)
library(readxl)
library(dplyr)
library(readr)
library(tibble)
library(mice)
library(Hmisc)
library(car)    
library(cluster)
library(ggrepel)
library(MASS)
library(showtext)
showtext_auto()
```

## 第一题

```{r}
df <- as.data.frame(read_excel("case6.xls"))
rownames(df) <- df[[1]]
df <- df[-1]
pca <- princomp(df,cor = TRUE)
print(summary(pca)) #特征根的平方根和方差贡献率
print(pca$loadings) #因子载荷
print(screeplot(pca, type="lines"))  # 碎石图
print(pca$scores) #得分

# 用前三个主成分得分进行聚类
scores <- pca$score[,1:3]
d<-dist(scores)
repca<-hclust(d)
model1<-cutree(repca, k=3)

# 用原始数据聚类
df <- scale(df, center=TRUE, scale=TRUE) #按列规范化，均值为0，方差为1
d1 <- dist(df,method="euclidean", diag=F, upper=F)
re<-hclust(d1)
model2<-cutree(re, k=3)
print(plot(repca, hang=-1))
print(plot(re, hang=-1))

set.seed(123)  
kmeans_res <- kmeans(scores, centers = 3, nstart = 25)
labels <- kmeans_res$cluster

res <- data.frame(
  行业 = rownames(scores),
  第一主成分得分 = scores[, 1],
  第二主成分得分 = scores[, 2],
  第三主成分得分 = scores[,3],
  分类 = labels
)

print(res) # 各行类分类情况

ggplot(res, aes(x = 第一主成分得分, y = 第二主成分得分, color = factor(分类))) +
  geom_point(size = 4) +
  geom_text(aes(label = 行业), hjust = 0, vjust = 0, size = 3) +
  labs(title = "13个行业在前两个主成分上的散点图",
       x = "第一主成分得分",
       y = "第二主成分得分",
       color = "类别") +
  theme_minimal()
```

由碎石图和累计方差贡献率，选择前三个主成分，累计方差贡献率达到0.87，其中第一主成分的方差贡献率为0.39，第二主成分的方差贡献率为0.36，第三主成分的方差贡献率为0.12。

第一主成分主要与X1,X2,X3有关，第二主成分主要与X4，X6有关，第三主成分主要与X8有关。用前三个主成分得分进行聚类分析与用原始数据进行聚类分析对比，
画出谱系聚类图，两者结果相同，机器单独为一类，电力、煤炭、建材、皮革为一类，剩余为一类。

而使用k-means进行聚类，机器、冶金为一类，电力、煤炭、建材为一类，其余为一类。可以画出13个行业在前两个主成分上的散点图。

# 第二题

```{r}
df <- as.data.frame(read_excel("ex6.7.xls"))
rownames(df) <- df[[1]]
df <- df[-1]
pca <- princomp(df,cor = TRUE)
print(summary(pca)) #特征根的平方根和方差贡献率
print(pca$loadings) #因子载荷
print(screeplot(pca, type="lines"))  # 碎石图
print(pca$scores) #得分

# 用前三个主成分得分进行聚类
scores <- pca$score[,1:3]
d<-dist(scores)
repca<-hclust(d)
model1<-cutree(repca, k=3)

# 用原始数据聚类
df <- scale(df, center=TRUE, scale=TRUE) #按列规范化，均值为0，方差为1
d1 <- dist(df,method="euclidean", diag=F, upper=F)
re<-hclust(d1)
model2<-cutree(re, k=3)
print(plot(repca, hang=-1))
print(plot(re, hang=-1))

set.seed(123)  
kmeans_res <- kmeans(scores, centers = 3, nstart = 25)
labels <- kmeans_res$cluster

res <- data.frame(
  行业 = rownames(scores),
  第一主成分得分 = scores[, 1],
  第二主成分得分 = scores[, 2],
  第三主成分得分 = scores[,3],
  分类 = labels
)

print(res) # 各行类分类情况

ggplot(res, aes(x = 第一主成分得分, y = 第二主成分得分, color = factor(分类))) +
  geom_point(size = 4) +
  geom_text(aes(label = 行业), hjust = 0, vjust = 0, size = 3) +
  labs(title = "13个行业在前两个主成分上的散点图",
       x = "第一主成分得分",
       y = "第二主成分得分",
       color = "类别") +
  theme_minimal()

```
 
由碎石图和累计方差贡献率，选择前三个主成分，累计方差贡献率达到0.89，其中第一主成分的方差贡献率为0.67，第二主成分的方差贡献率为0.15，第三主成分的方差贡献率为0.07。
第一主成分主要与交通通讯、家庭服务、教育有关，第二主成分主要与衣着、医疗有关，第三主成分主要与衣着有关。

用前三个主成分得分进行聚类分析，上海、北京、天津、浙江、福建、广东为一类，广西、海南、西藏、甘肃、青海、江西、贵州、四川、云南为一类，其余为一类。

而用原始数据进行聚类分析对比，上海、北京、天津、浙江、福建、广东仍然为一类，西藏、广西、海南、河南、河北、宁夏、黑龙江、新疆、四川、云南、甘肃、青海、江西、贵州为一类，其余为一类。

使用k-means进行聚类，上海、北京、天津、浙江、广东仍然为一类，安徽、江西、广西、海南、四川、贵州、云南、西藏、甘肃、青海为一类，其余为一类。可以画出各个省份在前两个主成分上的散点图。