library(car)
library(MASS)
library(showtext)
showtext_auto()
clean <- function(df){
df <- df[-1, ]  # 删除中文描述的行
#print(str(df)) # 查看每列的类型
# 要转换成数值格式的列
numeric_cols <- c("age", "sbp", "dbp", "weight", "height", "FPG", "TG", "HDL-C")
df <- df |>
mutate(
across(all_of(numeric_cols), parse_number)
)
# 观察到smoke列有多种回答
df <- df %>%
mutate(
smoke = case_when(
smoke == "是" ~ "是",
smoke %in% c("否", "已戒烟", "戒烟3年", "戒烟2个月") ~ "否",
TRUE ~ NA_character_
) %>%
factor(levels = c("否", "是"))
)
# 同样，drunk列有“是”“否”“无”三种回答
df <- df %>%
mutate(
drunk = case_when(
drunk == "是" ~ "是",
drunk %in% c("否", "无") ~ "否",
TRUE ~ NA_character_
) %>%
factor(levels = c("否", "是"))
)
df <- df %>% filter(!is.na(gender))
meth <- rep("pmm", ncol(df))
names(meth) <- names(df)  # 把列名赋给 meth
meth["smoke"] <- "logreg"
meth["drunk"] <- "logreg"
df <- suppressWarnings(mice(df, m = 10, maxit = 50, method =meth, printFlag = FALSE,seed=42)) #多重插补
df <- complete(df, 1) #选取第一个
return(df)
}
df2 <- read_excel("sample.xls",sheet = "Sheet2")
df2 <- clean(df2) # 处理Sheet2
df = df2 #不妨选df2作为接下来分析的对象
df <- df %>%
mutate(BMI = round(weight / (height / 100)^2, 2)) # BMI = 体重/ （身高的平方）
df <- df[df$BMI <= 50, ]
X <- c("BMI","FPG","sbp","dbp","TG","HDL-C")
tests <- lapply(df[X], shapiro.test)
print(tests)
par(mfrow = c(2, 4))
for (var in X) {
qqnorm(df[[var]], main = paste("Q-Q Plot for", var))
qqline(df[[var]], col = "red")
}
par(mfrow = c(1, 1))
cor_matrix <- cor(df[X], use = "complete.obs")
p_matrix <- cor.mtest(df[X], use = "complete.obs")
print(round(cor_matrix, 2))
print(round(p_matrix$p,3))
corrplot(cor_matrix, method = "color", type = "upper", order = "hclust",
addCoef.col = "black",
tl.col = "black", tl.srt = 45,
sig.level = 0.05, insig = "blank",p.mat = p_matrix$p)
df$Overweight <- ifelse(df$BMI >= 25, 1, 0) # 超重
df$Hyperglycemia <- ifelse(df$FPG >= 6.1, 1, 0) # 高血糖
df$HTN <- ifelse(df$sbp >= 140| df$dbp >= 90, 1, 0) # 高血压
df$FBG <- ifelse(df$TG >= 1.7 |
(df$`HDL-C` < 0.9 & df$gender == "男") |
(df$`HDL-C` < 1 & df$gender == "女"), 1, 0) # 空腹血
df$sick <- ifelse(rowSums(cbind(df$Overweight,
df$Hyperglycemia,
df$HTN,
df$FBG)) >= 3, 1, 0) # 是否患代谢综合征，1为患，0为不患
df <- df |> mutate(
sick = factor(sick, levels = c(0,1)),
gender = as.factor(gender)
)
print(table(df$sick))
prop <- prop.table(table(df$sick))
print(prop)
table(df$gender, df$sick)
contingency_table <- table(df$gender, df$sick)
chisq_test <- chisq.test(contingency_table) # 卡方检验
#fisher.test(contingency_table)
print(chisq_test)
df_sick <- df %>% filter(sick == 1)
sick_male <- df_sick %>%
filter(gender == "男") %>%
dplyr::select(all_of(X))
sick_female <- df_sick %>%
filter(gender == "女") %>%
dplyr::select(all_of(X))
df_healthy <- df %>% filter(sick == 0)
healthy_male <- df_healthy %>%
filter(gender == "男") %>%
dplyr::select(all_of(X))
healthy_female <- df_healthy %>%
filter(gender == "女") %>%
dplyr::select(all_of(X))
test_sick <- HotellingsT2(sick_male, sick_female)
print(test_sick)
test_healthy <- HotellingsT2(healthy_male, healthy_female)
print(test_healthy)
CI <- function(df,alpha = 0.05){
n <- nrow(df)      # 样本量
p <- ncol(df)      # 变量数量
X_bar <- colMeans(df) # 样本均值向量
S <- cov(df)        # 样本协方差矩阵
sds <- apply(df, 2, sd)
adjusted_alpha <- alpha / p   # Bonferroni校正
t_val <- qt(1 - adjusted_alpha / 2, df = n - 1)
margin <- t_val * sds / sqrt(n)
lower_bounds <- X_bar - margin
upper_bounds <- X_bar + margin
result <- data.frame(
Variable = names(X_bar),
Mean = X_bar,
Lower_Bound = lower_bounds,
Upper_Bound = upper_bounds
)
result[, c("Mean", "Lower_Bound", "Upper_Bound")] <-
round(result[, c("Mean", "Lower_Bound", "Upper_Bound")], 2)
print(result)
}
CI(sick_male)
CI(healthy_male)
CI(healthy_female)
ggplot(df_sick, aes(x = sbp, y = dbp, color = gender)) +
geom_point(alpha = 0.5) +
stat_ellipse(type = "t", level = 0.95) +
labs(
title = "患病群体中不同性别的SBP与DBP均值置信椭圆",
x = "收缩压SBP",
y = "舒张压DBP",
color = "性别"
) +
theme_bw() +
scale_color_manual(values = c("男" = "blue", "女" = "red"))
ggplot(df_healthy, aes(x =sbp, y = dbp, color = gender)) +
geom_point(alpha = 0.5) +
stat_ellipse(type = "t", level = 0.95) +
labs(
title = "未患病群体中不同性别的SBP与DBP均值置信椭圆",
x = "收缩压SBP",
y = "舒张压DBP",
color = "性别"
) +
theme_bw() +
scale_color_manual(values = c("男" = "blue", "女" = "red"))
df2 <- read_excel("ex2.1.xls")
model <- lm(y ~ x1+x2+x3+x4, data = df2)
summary(model)
X2 <- c("x1","x2","x3","x4")
par(mfrow = c(1, 4))
for (var in X2) {
qqnorm(df2[[var]], main = paste("Q-Q Plot for", var))
qqline(df2[[var]], col = "red")
}
par(mfrow = c(1, 1))
normal_test <- mvn(df2[X2],descriptives = FALSE,univariate_test = "SW")
print(normal_test$univariate_normality)
print(normal_test$multivariate_normality)
test_pca <- function(df) {
pca <- prcomp(df, scale. = TRUE)
score <- pca$x
n_features <- ncol(score)
for (i in 1:n_features) {
pc <- score[, i]
cat(paste("检验主成分", i,"\n"))
# 使用 Shapiro-Wilk 检验
shapiro_test <- shapiro.test(pc)
print(shapiro_test)
# if (shapiro_test$p.value < 0.05) {
#   cat(paste("结论: P值 < 0.05，拒绝正态性假设。\n\n"))
#   all_normal <- FALSE
# } else {
#   cat(paste("结论: P值 > 0.05，无法拒绝正态性假设。\n\n"))
# }
par(mfrow = c(1, 2))
# 绘制Q-Q图
qqnorm(pc, main = paste("Q-Q Plot of ", i))
qqline(pc, col = "red", lwd = 2)
Sys.sleep(1)
}
par(mfrow = c(1, 1))
}
test_pca(df2)
options(htmltools.dir.version = FALSE)
library(knitr)
opts_knit$set(eval.after = 'fig.cap')
library(tidyverse)
library(reshape2)
library(ggplot2)
library(readxl)
library(dplyr)
library(readr)
library(gtsummary)
library(mice)
library(Hmisc)
library(naniar)
library(corrplot)
library(ICSNP)
library(MVN)
library(car)
library(MASS)
library(showtext)
showtext_auto()
clean <- function(df){
df <- df[-1, ]  # 删除中文描述的行
#print(str(df)) # 查看每列的类型
# 要转换成数值格式的列
numeric_cols <- c("age", "sbp", "dbp", "weight", "height", "FPG", "TG", "HDL-C")
df <- df |>
mutate(
across(all_of(numeric_cols), parse_number)
)
# 观察到smoke列有多种回答
df <- df %>%
mutate(
smoke = case_when(
smoke == "是" ~ "是",
smoke %in% c("否", "已戒烟", "戒烟3年", "戒烟2个月") ~ "否",
TRUE ~ NA_character_
) %>%
factor(levels = c("否", "是"))
)
# 同样，drunk列有“是”“否”“无”三种回答
df <- df %>%
mutate(
drunk = case_when(
drunk == "是" ~ "是",
drunk %in% c("否", "无") ~ "否",
TRUE ~ NA_character_
) %>%
factor(levels = c("否", "是"))
)
df <- df %>% filter(!is.na(gender))
meth <- rep("pmm", ncol(df))
names(meth) <- names(df)  # 把列名赋给 meth
meth["smoke"] <- "logreg"
meth["drunk"] <- "logreg"
df <- suppressWarnings(mice(df, m = 10, maxit = 50, method =meth, printFlag = FALSE,seed=42)) #多重插补
df <- complete(df, 1) #选取第一个
return(df)
}
df2 <- read_excel("sample.xls",sheet = "Sheet2")
df2 <- clean(df2)
df = df2
df <- df %>%
mutate(BMI = round(weight / (height / 100)^2, 2)) # BMI = 体重/ （身高的平方）
df <- df[df$BMI <= 50, ]
X <- c("BMI","FPG","sbp","dbp","TG","HDL-C")
tests <- lapply(df[X], shapiro.test)
print(tests)
par(mfrow = c(2, 4))
for (var in X) {
qqnorm(df[[var]], main = paste("Q-Q Plot for", var))
qqline(df[[var]], col = "red")
}
par(mfrow = c(1, 1))
cor_matrix <- cor(df[X], use = "complete.obs")
p_matrix <- cor.mtest(df[X], use = "complete.obs")
print(round(cor_matrix, 2))
print(round(p_matrix$p,3))
corrplot(cor_matrix, method = "color", type = "upper", order = "hclust",
addCoef.col = "black",
tl.col = "black", tl.srt = 45,
sig.level = 0.05, insig = "blank",p.mat = p_matrix$p)
df$Overweight <- ifelse(df$BMI >= 25, 1, 0) # 超重
df$Hyperglycemia <- ifelse(df$FPG >= 6.1, 1, 0) # 高血糖
df$HTN <- ifelse(df$sbp >= 140| df$dbp >= 90, 1, 0) # 高血压
df$FBG <- ifelse(df$TG >= 1.7 |
(df$`HDL-C` < 0.9 & df$gender == "男") |
(df$`HDL-C` < 1 & df$gender == "女"), 1, 0) # 空腹血
df$sick <- ifelse(rowSums(cbind(df$Overweight,
df$Hyperglycemia,
df$HTN,
df$FBG)) >= 3, 1, 0) # 是否患代谢综合征，1为患，0为不患
df <- df |> mutate(
sick = factor(sick, levels = c(0,1)),
gender = as.factor(gender)
)
print(table(df$sick))
prop <- prop.table(table(df$sick))
print(prop)
table(df$gender, df$sick)
contingency_table <- table(df$gender, df$sick)
chisq_test <- chisq.test(contingency_table) # 卡方检验
#fisher.test(contingency_table)
print(chisq_test)
df_sick <- df %>% filter(sick == 1)
sick_male <- df_sick %>%
filter(gender == "男") %>%
dplyr::select(all_of(X))
sick_female <- df_sick %>%
filter(gender == "女") %>%
dplyr::select(all_of(X))
df_healthy <- df %>% filter(sick == 0)
healthy_male <- df_healthy %>%
filter(gender == "男") %>%
dplyr::select(all_of(X))
healthy_female <- df_healthy %>%
filter(gender == "女") %>%
dplyr::select(all_of(X))
test_sick <- HotellingsT2(sick_male, sick_female)
print(test_sick)
test_healthy <- HotellingsT2(healthy_male, healthy_female)
print(test_healthy)
CI <- function(df,alpha = 0.05){
n <- nrow(df)      # 样本量
p <- ncol(df)      # 变量数量
X_bar <- colMeans(df) # 样本均值向量
S <- cov(df)        # 样本协方差矩阵
sds <- apply(df, 2, sd)
adjusted_alpha <- alpha / p   # Bonferroni校正
t_val <- qt(1 - adjusted_alpha / 2, df = n - 1)
margin <- t_val * sds / sqrt(n)
lower_bounds <- X_bar - margin
upper_bounds <- X_bar + margin
result <- data.frame(
Variable = names(X_bar),
Mean = X_bar,
Lower_Bound = lower_bounds,
Upper_Bound = upper_bounds
)
result[, c("Mean", "Lower_Bound", "Upper_Bound")] <-
round(result[, c("Mean", "Lower_Bound", "Upper_Bound")], 2)
print(result)
}
CI(sick_male)
CI(healthy_male)
CI(healthy_female)
ggplot(df_sick, aes(x = sbp, y = dbp, color = gender)) +
geom_point(alpha = 0.5) +
stat_ellipse(type = "t", level = 0.95) +
labs(
title = "患病群体中不同性别的SBP与DBP均值置信椭圆",
x = "收缩压SBP",
y = "舒张压DBP",
color = "性别"
) +
theme_bw() +
scale_color_manual(values = c("男" = "blue", "女" = "red"))
ggplot(df_healthy, aes(x =sbp, y = dbp, color = gender)) +
geom_point(alpha = 0.5) +
stat_ellipse(type = "t", level = 0.95) +
labs(
title = "未患病群体中不同性别的SBP与DBP均值置信椭圆",
x = "收缩压SBP",
y = "舒张压DBP",
color = "性别"
) +
theme_bw() +
scale_color_manual(values = c("男" = "blue", "女" = "red"))
df2 <- read_excel("ex2.1.xls")
model <- lm(y ~ x1+x2+x3+x4, data = df2)
summary(model)
X2 <- c("x1","x2","x3","x4")
par(mfrow = c(1, 4))
for (var in X2) {
qqnorm(df2[[var]], main = paste("Q-Q Plot for", var))
qqline(df2[[var]], col = "red")
}
par(mfrow = c(1, 1))
normal_test <- mvn(df2[X2],descriptives = FALSE,univariate_test = "SW")
print(normal_test$univariate_normality)
print(normal_test$multivariate_normality)
test_pca <- function(df) {
pca <- prcomp(df, scale. = TRUE) # 标准化并进行pca
score <- pca$x
n_features <- ncol(score)
for (i in 1:n_features) {
pc <- score[, i]
cat(paste("检验主成分", i,"\n"))
# 使用 Shapiro-Wilk 检验
shapiro_test <- shapiro.test(pc)
print(shapiro_test)
par(mfrow = c(1, 2))
# 绘制Q-Q图
qqnorm(pc, main = paste("Q-Q Plot of ", i))
qqline(pc, col = "red", lwd = 2)
Sys.sleep(1)
}
par(mfrow = c(1, 1))
}
test_pca(df2)
x_bar <- colMeans(df2)
S <- cov(df2)
d2 <- mahalanobis(df2, center = x_bar, cov = S)
qqplot(qchisq(ppoints(length(d2)), df = 4), d2,
xlab = "卡方分布分位数",
ylab = "马氏距离的平方")
abline(0, 1, col = "red")
vars1 <- c("x1", "x2")
vars2 <- c("x3", "x4")
p_val <- matrix(NA, 2, 2)
corr <- matrix(NA,2,2)
for (i in 1:2) {
for (j in 1:2) {
test <- cor.test(df2[[vars1[i]]], df2[[vars2[j]]])
p_val[i, j] <- test$p.value
corr[i,j] <- test$estimate
}
}
colnames(p_val) <- vars2
rownames(p_val) <- vars1
colnames(corr) <- vars2
rownames(corr) <- vars1
print(corr)
print(p_val)
test_independence <- function(df, group_sizes, alpha = 0.05) {
n <- nrow(df) # 样本量
p <- ncol(df) # 总变量数
S <- cov(data) # 协方差阵
A <- (n - 1) * S # 离差阵
det_A <- det(A)
Aii1 <- 1
start <- 1
for (size in group_sizes) {
end <- start + size - 1
Aii <- A[start:end, start:end, drop = FALSE]
Aii1 <- Aii1 * det(Aii)
start <- end + 1
}
V <- det_A / Aii1
f <- 4
b <- n - 3.5
xi <- -b * log(V)
p_value <- pchisq(xi, df = f, lower.tail = FALSE)
return(list(
V = V,
b = b,
xi = xi,
df = f,
p_value = p_value
))
}
test_independence(df2,group_sizes = c(2,2))
test_independence <- function(df, group_sizes, alpha = 0.05) {
n <- nrow(df) # 样本量
p <- ncol(df) # 总变量数
S <- cov(df) # 协方差阵
A <- (n - 1) * S # 离差阵
det_A <- det(A)
Aii1 <- 1
start <- 1
for (size in group_sizes) {
end <- start + size - 1
Aii <- A[start:end, start:end, drop = FALSE]
Aii1 <- Aii1 * det(Aii)
start <- end + 1
}
V <- det_A / Aii1
f <- 4
b <- n - 3.5
xi <- -b * log(V)
p_value <- pchisq(xi, df = f, lower.tail = FALSE)
return(list(
V = V,
b = b,
xi = xi,
df = f,
p_value = p_value
))
}
test_independence(df2,group_sizes = c(2,2))
test_independence <- function(df, group_sizes, alpha = 0.05) {
n <- nrow(df) # 样本量
p <- ncol(df) # 总变量数
S <- cov(df) # 协方差阵
A <- (n - 1) * S # 离差阵
det_A <- det(A)
Aii1 <- 1
start <- 1
for (size in group_sizes) {
end <- start + size - 1
Aii <- A[start:end, start:end, drop = FALSE]
Aii1 <- Aii1 * det(Aii)
start <- end + 1
}
V <- det_A / Aii1
f <- 4
b <- n - 3.5
xi <- -b * log(V)
p_value <- pchisq(xi, df = f, lower.tail = FALSE)
print(p_value)
}
test_independence(df2,group_sizes = c(2,2))
test_independence <- function(df, group_sizes, alpha = 0.05) {
n <- nrow(df) # 样本量
p <- ncol(df) # 总变量数
S <- cov(df) # 协方差阵
A <- (n - 1) * S # 离差阵
det_A <- det(A)
Aii1 <- 1
start <- 1
for (size in group_sizes) {
end <- start + size - 1
Aii <- A[start:end, start:end, drop = FALSE]
Aii1 <- Aii1 * det(Aii)
start <- end + 1
}
V <- det_A / Aii1
f <- 4
b <- n - 3.5
xi <- -b * log(V)
p_value <- pchisq(xi, df = f, lower.tail = FALSE)
print(p_value)
}
test_independence(df2[X2],group_sizes = c(2,2))
