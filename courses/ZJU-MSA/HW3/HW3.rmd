---
title: "Homework 3"
author: "张子乐,3230104237"
output:
  pdf_document:
    latex_engine: xelatex
  html_document:
    df_print: paged
header-includes:
  - \usepackage{ctex}
---
```{r setup, message = F, include=FALSE}
options(htmltools.dir.version = FALSE)
library(knitr)
opts_knit$set(eval.after = 'fig.cap')
library(tidyverse)
library(reshape2)
library(ggplot2)
library(readxl)
library(dplyr)
library(readr)
library(gtsummary)
library(mice)
library(Hmisc)
library(naniar)
library(corrplot)
library(ICSNP)  
library(MVN)
library(car)    
library(MASS)
library(showtext)
showtext_auto()
```

## 第一题

### 数据预处理

对数据的预处理与作业二一致，将字符串格式转为数值格式。观察到smoke列和drunk列有多种不同的回答，统一改为“是”“否”。
使用多重插补的方法，对于连续型变量使用Predictive Mean Matching(pmm)，对二分类变量使用Logistic Regression Imputation(logreg)，而对于性别变量则直接删除含缺失值的行。
后续需要用到BMI，因此计算BMI作为新的变量，观察到BMI出现了异常值581，将其删除。

```{r}
clean <- function(df){
  df <- df[-1, ]  # 删除中文描述的行
  #print(str(df)) # 查看每列的类型
  # 要转换成数值格式的列
  numeric_cols <- c("age", "sbp", "dbp", "weight", "height", "FPG", "TG", "HDL-C") 
  df <- df |> 
    mutate(
      across(all_of(numeric_cols), parse_number)
    )
  
  # 观察到smoke列有多种回答
  df <- df %>%
    mutate(
      smoke = case_when(
        smoke == "是" ~ "是",
        smoke %in% c("否", "已戒烟", "戒烟3年", "戒烟2个月") ~ "否",
        TRUE ~ NA_character_
      ) %>%
        factor(levels = c("否", "是"))  
    )
  # 同样，drunk列有“是”“否”“无”三种回答
  df <- df %>%
    mutate(
      drunk = case_when(
        drunk == "是" ~ "是",
        drunk %in% c("否", "无") ~ "否",
        TRUE ~ NA_character_
      ) %>%
        factor(levels = c("否", "是"))  
    )
  df <- df %>% filter(!is.na(gender))
  
  meth <- rep("pmm", ncol(df))
  names(meth) <- names(df)  # 把列名赋给 meth
  meth["smoke"] <- "logreg"
  meth["drunk"] <- "logreg"
  df <- suppressWarnings(mice(df, m = 10, maxit = 50, method =meth, printFlag = FALSE,seed=42)) #多重插补
  df <- complete(df, 1) #选取第一个
  return(df)
}

df2 <- read_excel("sample.xls",sheet = "Sheet2")
df2 <- clean(df2) 
df = df2 
df <- df %>%
  mutate(BMI = round(weight / (height / 100)^2, 2)) # BMI = 体重/ （身高的平方）
df <- df[df$BMI <= 50, ] 
```

### 正态性检验


```{r}
X <- c("BMI","FPG","sbp","dbp","TG","HDL-C") 
tests <- lapply(df[X], shapiro.test)
print(tests)

par(mfrow = c(2, 4)) 
for (var in X) {
  qqnorm(df[[var]], main = paste("Q-Q Plot for", var))
  qqline(df[[var]], col = "red")
}
par(mfrow = c(1, 1))
```
使用Shapiro-Wilk正态性检验，在95%的置信水平下，p值小于0.05则拒绝原假设，即不符合正态性。

从结果可以看出，BMI、FPG、SBP、DBP、TG和HDL-C都不具有正态性。画出的QQ图也可以验证这一点。

### 相关性检验

```{r}
cor_matrix <- cor(df[X], use = "complete.obs")
p_matrix <- cor.mtest(df[X], use = "complete.obs")
print(round(cor_matrix, 2))
print(round(p_matrix$p,3))
corrplot(cor_matrix, method = "color", type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45, 
         sig.level = 0.05, insig = "blank",p.mat = p_matrix$p) 
```
如热力图所示，除了SBP与HDL-C、DBP与HDL-C外，其余变量间的相关性均显著。HDL-C与其它变量均成负相关关系，
其余变量间均成正相关关系。其中DBP与SBP的正相关性最强，相关系数为0.8；HDL-C与TG的负相关性最强，相关系数为-0.34。

### 分析患代谢综合症的比例

首先判断每个样本是否超重、高血糖、高血压、空腹血，从而判断是否患代谢综合症。

```{r}
df$Overweight <- ifelse(df$BMI >= 25, 1, 0) # 超重
df$Hyperglycemia <- ifelse(df$FPG >= 6.1, 1, 0) # 高血糖
df$HTN <- ifelse(df$sbp >= 140| df$dbp >= 90, 1, 0) # 高血压
df$FBG <- ifelse(df$TG >= 1.7 | 
                   (df$`HDL-C` < 0.9 & df$gender == "男") | 
                   (df$`HDL-C` < 1 & df$gender == "女"), 1, 0) # 空腹血
df$sick <- ifelse(rowSums(cbind(df$Overweight, 
                                df$Hyperglycemia, 
                                df$HTN, 
                                df$FBG)) >= 3, 1, 0) # 是否患代谢综合征，1为患，0为不患
df <- df |> mutate(
    sick = factor(sick, levels = c(0,1)),
    gender = as.factor(gender)
)
print(table(df$sick))
prop <- prop.table(table(df$sick))
print(prop)
```
269个样本中有34人患有代谢综合征，占12.64%。

### 患代谢综合症的性别差异

判断患代谢综合征的比例有没有性别差异,34名患者中仅4名为女性，仅占11.77%。
```{r}
table(df$gender, df$sick)
contingency_table <- table(df$gender, df$sick)
chisq_test <- chisq.test(contingency_table) # 卡方检验
#fisher.test(contingency_table)
print(chisq_test)
```
原假设H0：患代谢综合征的比例没有显著的性别差异。
备择假设H1：患代谢综合征的比例有显著的性别差异。

通过卡方检验，p = 0.002638 < 0.05，拒绝原假设，选择备择假设，即患代谢综合征的比例有显著的性别差异。

### 不同性别是否患代谢综合症群体各类指标的均值估计和置信区间

```{r}
df_sick <- df %>% filter(sick == 1)

sick_male <- df_sick %>% 
  filter(gender == "男") %>%
  dplyr::select(all_of(X))

sick_female <- df_sick %>%
  filter(gender == "女") %>%
  dplyr::select(all_of(X))

df_healthy <- df %>% filter(sick == 0)

healthy_male <- df_healthy %>%
  filter(gender == "男") %>%
  dplyr::select(all_of(X))

healthy_female <- df_healthy %>%
  filter(gender == "女") %>%
  dplyr::select(all_of(X))


test_sick <- HotellingsT2(sick_male, sick_female)
print(test_sick)

```
检测的指标为BMI、FPG、SBP、DBP、TG和HDL-C。

H0:患病组中检测指标的均值向量没有显著的性别差异。

H1：患病组中检测指标的均值向量有显著的性别差异。

霍特林统计量$T^2 = 1.698$，p = 0.1599 > 0.05，无法拒绝原假设，因此患病组中检测指标的均值向量没有显著的性别差异。

```{r}
test_healthy <- HotellingsT2(healthy_male, healthy_female)
print(test_healthy)
```
H0:未患病组中检测指标的均值向量没有显著的性别差异。

H1：未患病组中检测指标的均值向量有显著的性别差异。

霍特林统计量$T^2 = 15.187$，p < 0.05，拒绝原假设，因此未患病组中检测指标的均值向量有显著的性别差异。


下面计算每个群体均值向量的置信区间，取置信水平为95%。

```{r}
CI <- function(df,alpha = 0.05){
  n <- nrow(df)      # 样本量
  p <- ncol(df)      # 变量数量
  X_bar <- colMeans(df) # 样本均值向量
  S <- cov(df)        # 样本协方差矩阵
  sds <- apply(df, 2, sd)
  
  adjusted_alpha <- alpha / p   # Bonferroni校正
  t_val <- qt(1 - adjusted_alpha / 2, df = n - 1)
  margin <- t_val * sds / sqrt(n) 
  
  lower_bounds <- X_bar - margin
  upper_bounds <- X_bar + margin
  
  result <- data.frame(
    Variable = names(X_bar),
    Mean = X_bar,
    Lower_Bound = lower_bounds,
    Upper_Bound = upper_bounds
  )
  result[, c("Mean", "Lower_Bound", "Upper_Bound")] <- 
    round(result[, c("Mean", "Lower_Bound", "Upper_Bound")], 2)
  
  print(result)
}
```

患病男性群体的均值向量和置信区间：

```{r}
CI(sick_male)
```

未患病男性群体的均值向量和置信区间：

```{r}
CI(healthy_male)
```

未患病女性群体的均值向量和置信区间：

```{r}
CI(healthy_female)
```





我们可以画出置信椭球可视化上面的结果。这里选取收缩压SBP和舒张压DBP这两个变量。

```{r}
ggplot(df_sick, aes(x = sbp, y = dbp, color = gender)) +
  geom_point(alpha = 0.5) + 
  stat_ellipse(type = "t", level = 0.95) + 
  labs(
    title = "患病群体中不同性别的SBP与DBP均值置信椭圆",
    x = "收缩压SBP",
    y = "舒张压DBP",
    color = "性别"
  ) +
  theme_bw() +
  scale_color_manual(values = c("男" = "blue", "女" = "red"))

ggplot(df_healthy, aes(x =sbp, y = dbp, color = gender)) +
  geom_point(alpha = 0.5) +
  stat_ellipse(type = "t", level = 0.95) +
  labs(
    title = "未患病群体中不同性别的SBP与DBP均值置信椭圆",
    x = "收缩压SBP",
    y = "舒张压DBP",
    color = "性别"
  ) +
  theme_bw() +
  scale_color_manual(values = c("男" = "blue", "女" = "red"))
```
从置信椭球的结果可以看出，患病群体不同性别的置信椭圆完全重叠，而未患病群体的置信椭圆存在更多未重叠的部分，一定程度上可以验证
未患病群体的均值向量具有显著的性别差异。

## 第二题

### 多元回归

建立回归方程如下：

```{r}
df2 <- read_excel("ex2.1.xls")
model <- lm(y ~ x1+x2+x3+x4, data = df2)
summary(model)
```
以上构建的多元线性回归模型具有统计学意义（F = 8.278,P = 0.0003 < 0.05），
因变量空腹血糖变异的 60.08% 可由血清总胆固醇、甘油、空腹胰岛素和糖化血红蛋白来解释（R2 = 0.6008，校正的
R2 = 0.5282）。

空腹胰岛素和糖化血红蛋白的偏回归系数检验的
p < 0.05，在 $\alpha$ = 0.05 的检验水准下有统计学显著性。其中空腹胰岛素的
回归系数为-0.2706, 表明对空腹血糖有显著的负向影响；糖化血红蛋白的回归系数为0.6382，说明对空腹血糖有显著的正向影响。

最终的多元回归方程可以写成：

y = 5.9433 + 0.1424 * x1 + 0.3515 * x2 - 0.2706 * x3 + 0.6382 * x4

### 多元正态

对(X1,X2,X3,X4)做多元正态检验，先画出每个单变量的QQ图。

```{r}
X2 <- c("x1","x2","x3","x4")
par(mfrow = c(1, 4)) 
for (var in X2) {
  qqnorm(df2[[var]], main = paste("Q-Q Plot for", var))
  qqline(df2[[var]], col = "red")
}
par(mfrow = c(1, 1))
```

然后使用mvn包进行多元正态性检验，其中对于每个单变量使用Shapiro-Wilk检验判断正态性，从检验结果和上面的QQ图可以看出，单变量x1和x2不具有显著的正态性。然后使用Henze-Zirkler检验进行多元正态检验，结果显示(X1,X2,X3,X4)不具有多元正态性。这和单变量的结果相符，如果单变量不符合正态分布，则它们的组合也不会服从多元正态分布。

```{r}
normal_test <- mvn(df2[X2],descriptives = FALSE,univariate_test = "SW")
print(normal_test$univariate_normality)
print(normal_test$multivariate_normality)
```
也可以使用课本上的主成分分析法进行多元正态检验。

```{r}
test_pca <- function(df) {
  
  pca <- prcomp(df, scale. = TRUE) # 标准化并进行pca
  
  score <- pca$x
  n_features <- ncol(score)
  
  for (i in 1:n_features) {
    pc <- score[, i]
    
    cat(paste("检验主成分", i,"\n"))
    
    # 使用 Shapiro-Wilk 检验
    shapiro_test <- shapiro.test(pc)
    print(shapiro_test)
    
    par(mfrow = c(1, 2))
    # 绘制Q-Q图
    qqnorm(pc, main = paste("Q-Q Plot of ", i))
    qqline(pc, col = "red", lwd = 2)
    
    Sys.sleep(1) 
  }
  par(mfrow = c(1, 1))
}

test_pca(df2)
```
由第一个主成分不具有一元正态性推出(X1,X2,X3,X4)不具有显著的多元正态性。

最后我们可以画出多元正态分布的QQ图，可以看出点并不在直线上，与我们上面的分析相符。

```{r}
x_bar <- colMeans(df2) 
S <- cov(df2)         
d2 <- mahalanobis(df2, center = x_bar, cov = S)

qqplot(qchisq(ppoints(length(d2)), df = 4), d2,
       xlab = "卡方分布分位数",
       ylab = "马氏距离的平方")
abline(0, 1, col = "red") 
```

### (X1,X2) 和 (X3,X4)是否相互独立

```{r}
test_independence <- function(df, group_sizes, alpha = 0.05) {
  n <- nrow(df) # 样本量
  p <- ncol(df) # 总变量数
  
  S <- cov(df) # 协方差阵
  A <- (n - 1) * S # 离差阵
  det_A <- det(A)
  
  
  Aii1 <- 1
  start <- 1
  for (size in group_sizes) {
    end <- start + size - 1
    Aii <- A[start:end, start:end, drop = FALSE]
    Aii1 <- Aii1 * det(Aii)
    start <- end + 1
  }

  V <- det_A / Aii1
  f <- 4
  b <- n - 3.5
  
  xi <- -b * log(V)
  p_value <- pchisq(xi, df = f, lower.tail = FALSE)
  print(p_value)
}

test_independence(df2[X2],group_sizes = c(2,2))
```
H0：(X1,X2) 和 (X3,X4)相互独立，H1：(X1,X2) 和 (X3,X4)不相互独立。

检验的p > 0.05，无法拒绝原假设，即(X1,X2) 和 (X3,X4)相互独立。

## 第三题

### 多元回归

```{r}
df3 <- read_excel("ex2.5.xls")
model <- lm(y ~ x1+x2+x3+x4+x5+x6, data = df3)
summary(model)
```
以上构建的多元线性回归模型具有统计学意义（F = 2338,P < 0.05），
因变量财政收入变异的 99.85% 可由第一产业增加值、工业增加值、建筑业增加值、年末总人口、社会消费品零售总额和受灾面积来解释（R2 = 0.9985，校正的R2 = 0.9981）。

第一产业增加值、工业增加值和社会消费品零售总额的偏回归系数检验的
p < 0.05，在 $\alpha$ = 0.05 的检验水准下有统计学显著性。其中工业增加值的
回归系数为0.2308, 表明对财政收入有显著的负向影响；社会消费品零售总额的回归系数为0.46，说明对财政收入也有显著的正向影响；
而第一产业增加值的回归系数为-0.78，说明对财政收入有显著的负向作用。

最终的多元回归方程可以写成：

y = 3.7e+04 - 0.78* x1 + 0.23 * x2 + 0.54 * x3 - 0.31 * x4 + 0.46 * x5 - 0.58 * x6