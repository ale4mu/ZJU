library(corrplot)
library(ICSNP)
library(MVN)
library(car)
library(MASS)
library(showtext)
showtext_auto()
df <- read_excel("肝胆病患者检查数据.xls",skip = 1)
df <- df[,-1] #去除第一列
cols <- names(df)
df <- as.data.frame(lapply(df[cols], as.numeric))
df$sick <- ifelse(df$group == 5,0,1) # 只有第五组是正常的
df$sick <- factor(df$sick,levels = c(0, 1),labels = c("Healthy", "Sick")) # 0为正常，1为患病
df <- df[,-5] # 删除group列
df1 <- df[df$sick == "Healthy",1:4]
df2 <- df[df$sick == "Sick",1:4]
# 处理测试样本
data <- read_excel("体检资料.xls")
data <- data[,c("体检编号","总胆红素（T-BIL）","白蛋白（Alb）","碱性磷酸酶（ALP）","谷丙转氨酶（ALT）")]
names(data) <- c("ID", "BIL", "Alb", "ALP", "ALT")
cols <- names(data[,-1])
data[-1] <- as.data.frame(lapply(data[cols], as.numeric))
test1 <- function(df1,df2)
{
res1 <- HotellingsT2(df1,df2)
print(res1)
return (res1)
}
res1 <- test1(df1,df2)
varcomp <- function(covmat,n) {
if (is.list(covmat)) {
if (length(covmat) < 2)
stop("covmat must be a list with at least 2 elements")
ps <- as.vector(sapply(covmat,dim))
if (sum(ps[1] == ps) != length(ps))
stop("all covariance matrices must have the same dimension")
p <- ps[1]
q <- length(covmat)
if (length(n) == 1)
Ng <- rep(n,q)
else if (length(n) == q)
Ng <- n
else
stop("n must be equal length(covmat) or 1")
DNAME <- deparse(substitute(covmat))
}
else
stop("covmat must be a list")
ng <- Ng - 1
Ag <- lapply(1:length(covmat),function(i,mat,n) { n[i] * mat[[i]] },mat=covmat,n=ng)
A <- matrix(colSums(matrix(unlist(Ag),ncol=p^2,byrow=T)),ncol=p)
detAg <- sapply(Ag,det)
detA <- det(A)
V1 <- prod(detAg^(ng/2))/(detA^(sum(ng)/2))
kg <- ng/sum(ng)
l1 <- prod((1/kg)^kg)^(p*sum(ng)/2) * V1
rho <- 1 - (sum(1/ng) - 1/sum(ng))*(2*p^2+3*p-1)/(6*(p+1)*(q-1))
w2 <- p*(p+1) * ((p-1)*(p+2) * (sum(1/ng^2) - 1/(sum(ng)^2)) - 6*(q-1)*(1-rho)^2) / (48*rho^2)
f <- 0.5 * (q-1)*p*(p+1)
STATISTIC <- -2*rho*log(l1)
PVAL <- 1 - (pchisq(STATISTIC,f) + w2*(pchisq(STATISTIC,f+4) - pchisq(STATISTIC,f)))
names(STATISTIC) <- "corrected lambda*"
names(f) <- "df"
RVAL <- structure(list(statistic = STATISTIC, parameter = f,p.value = PVAL, data.name = DNAME, method = "Equality of Covariances Matrices Test"),class="htest")
return(RVAL)
}
test2 <- function(df1,df2)
{
s1 <- cov(df1)
s2 <- cov(df2)
covmat <- list(s1,s2)
res2 <- varcomp(covmat,n=c(4,4))
print(res2)
return(res2)
}
res2 <- test2(df1,df2)
test3 <- function(df)
{
res3 <- lda(sick~BIL+Alb+ALP+ALT,df)
print(res3)
return(res3)
}
res3 <- test3(df)
res4 <- predict(res3,data[,c("BIL", "Alb", "ALP", "ALT")])
colSums(is.na(data[c("BIL", "Alb", "ALP", "ALT")]))
test_data <- na.omit(data[,c("BIL", "Alb", "ALP", "ALT")])
res4 <- predict(res3,test_data)
test_data <- na.omit(data[,c("BIL", "Alb", "ALP", "ALT")])
res4 <- predict(res3,test_data)
print(res4)
which(complete.cases(data) == FALSE)
options(htmltools.dir.version = FALSE)
library(knitr)
opts_knit$set(eval.after = 'fig.cap')
library(tidyverse)
library(reshape2)
library(ggplot2)
library(readxl)
library(dplyr)
library(readr)
library(gtsummary)
library(mice)
library(Hmisc)
library(naniar)
library(corrplot)
library(ICSNP)
library(MVN)
library(car)
library(MASS)
library(showtext)
showtext_auto()
df <- read_excel("肝胆病患者检查数据.xls",skip = 1)
df <- df[,-1] #去除第一列
cols <- names(df)
df <- as.data.frame(lapply(df[cols], as.numeric))
df$sick <- ifelse(df$group == 5,0,1) # 只有第五组是正常的
df$sick <- factor(df$sick,levels = c(0, 1),labels = c("Healthy", "Sick")) # 0为正常，1为患病
df <- df[,-5] # 删除group列
df1 <- df[df$sick == "Healthy",1:4]
df2 <- df[df$sick == "Sick",1:4]
# 处理测试样本
data <- read_excel("体检资料.xls")
data <- data[,c("体检编号","总胆红素（T-BIL）","白蛋白（Alb）","碱性磷酸酶（ALP）","谷丙转氨酶（ALT）")]
names(data) <- c("ID", "BIL", "Alb", "ALP", "ALT")
cols <- names(data[,-1])
data[-1] <- as.data.frame(lapply(data[cols], as.numeric))
test1 <- function(df1,df2)
{
res1 <- HotellingsT2(df1,df2)
print(res1)
return (res1)
}
res1 <- test1(df1,df2)
varcomp <- function(covmat,n) {
if (is.list(covmat)) {
if (length(covmat) < 2)
stop("covmat must be a list with at least 2 elements")
ps <- as.vector(sapply(covmat,dim))
if (sum(ps[1] == ps) != length(ps))
stop("all covariance matrices must have the same dimension")
p <- ps[1]
q <- length(covmat)
if (length(n) == 1)
Ng <- rep(n,q)
else if (length(n) == q)
Ng <- n
else
stop("n must be equal length(covmat) or 1")
DNAME <- deparse(substitute(covmat))
}
else
stop("covmat must be a list")
ng <- Ng - 1
Ag <- lapply(1:length(covmat),function(i,mat,n) { n[i] * mat[[i]] },mat=covmat,n=ng)
A <- matrix(colSums(matrix(unlist(Ag),ncol=p^2,byrow=T)),ncol=p)
detAg <- sapply(Ag,det)
detA <- det(A)
V1 <- prod(detAg^(ng/2))/(detA^(sum(ng)/2))
kg <- ng/sum(ng)
l1 <- prod((1/kg)^kg)^(p*sum(ng)/2) * V1
rho <- 1 - (sum(1/ng) - 1/sum(ng))*(2*p^2+3*p-1)/(6*(p+1)*(q-1))
w2 <- p*(p+1) * ((p-1)*(p+2) * (sum(1/ng^2) - 1/(sum(ng)^2)) - 6*(q-1)*(1-rho)^2) / (48*rho^2)
f <- 0.5 * (q-1)*p*(p+1)
STATISTIC <- -2*rho*log(l1)
PVAL <- 1 - (pchisq(STATISTIC,f) + w2*(pchisq(STATISTIC,f+4) - pchisq(STATISTIC,f)))
names(STATISTIC) <- "corrected lambda*"
names(f) <- "df"
RVAL <- structure(list(statistic = STATISTIC, parameter = f,p.value = PVAL, data.name = DNAME, method = "Equality of Covariances Matrices Test"),class="htest")
return(RVAL)
}
test2 <- function(df1,df2)
{
s1 <- cov(df1)
s2 <- cov(df2)
covmat <- list(s1,s2)
res2 <- varcomp(covmat,n=c(4,4))
print(res2)
return(res2)
}
res2 <- test2(df1,df2)
test3 <- function(df)
{
res3 <- lda(sick~BIL+Alb+ALP+ALT,df)
print(res3)
return(res3)
}
res3 <- test3(df)
test_data <- na.omit(data[,c("BIL", "Alb", "ALP", "ALT")])
res4 <- predict(res3,test_data)
#print(res4)
df_plot <- df
df_plot$LD1 <- predict(res3, df[c("BIL", "Alb", "ALP", "ALT")])$x[, 1]
ggplot(df_plot, aes(x = LD1, fill = sick)) +
geom_density(alpha = 0.6) +
labs(title = "LDA 判别轴 LD1 密度分布",
x = "判别得分 (LD1)",
y = "密度") +
theme_minimal() +
scale_fill_brewer(palette = "Set1")
df_plot <- df
df_plot$LD1 <- predict(res3, df[c("BIL", "Alb", "ALP", "ALT")])$x[, 1]
ggplot(df_plot, aes(x = LD1, fill = sick)) +
geom_density(alpha = 0.6) +
labs(title = "LDA 判别轴密度图",
x = "判别得分 (LD1)",
y = "密度") +
theme_minimal() +
scale_fill_brewer(palette = "Set1")
install.packages(ROCR)
install.packages("ROCR")
options(htmltools.dir.version = FALSE)
library(knitr)
opts_knit$set(eval.after = 'fig.cap')
library(tidyverse)
library(reshape2)
library(ggplot2)
library(readxl)
library(dplyr)
library(readr)
library(gtsummary)
library(mice)
library(Hmisc)
library(naniar)
library(corrplot)
library(ICSNP)
library(MVN)
library(car)
library(MASS)
library(ROCR)
library(showtext)
showtext_auto()
df_plot <- df
df_plot$LD1 <- predict(res3, df[c("BIL", "Alb", "ALP", "ALT")])$x[, 1]
ggplot(df_plot, aes(x = LD1, fill = sick)) +
geom_density(alpha = 0.6) +
labs(title = "LDA 判别轴密度图",
x = "判别得分 (LD1)",
y = "密度") +
theme_minimal() +
scale_fill_brewer(palette = "Set1")
train_pred <- predict(res3, df[c("BIL", "Alb", "ALP", "ALT")])
pred_roc <- prediction(train_pred$posterior[, "Sick"], df$sick)
perf <- performance(pred_roc, "tpr", "fpr")
auc <- performance(pred_roc, "auc")@y.values[[1]]
plot(perf, main = paste("ROC 曲线 (AUC =", round(auc, 3), ")"))
abline(a = 0, b = 1, lty = 2, col = "gray")
train_pred <- predict(res3, df[c("BIL", "Alb", "ALP", "ALT")])
pred_roc <- prediction(train_pred$posterior[, "Sick"], df$sick)
perf <- performance(pred_roc, "tpr", "fpr")
auc <- performance(pred_roc, "auc")@y.values[[1]]
roc_data <- data.frame(
FPR = perf@x.values[[1]],   # False Positive Rate
TPR = perf@y.values[[1]]    # True Positive Rate
)
p <- ggplot(roc_data, aes(x = FPR, y = TPR)) +
geom_line(color = "#007acc", size = 1.2, alpha = 0.9) +  # 蓝色主曲线
geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray", alpha = 0.7) +
labs(
title = "ROC 曲线：LDA 模型判别性能",
subtitle = paste("AUC =", round(auc, 3)),
x = "假阳性率 (1 - 特异性)",
y = "真阳性率 (敏感性)"
) +
theme_minimal() +
theme(
plot.title = element_text(size = 16, face = "bold", color = "#222222"),
plot.subtitle = element_text(size = 12, face = "italic", color = "#555555"),
axis.title = element_text(size = 11),
axis.text = element_text(size = 10),
panel.grid.major = element_line(color = "#eaeaea", size = 0.5),
panel.grid.minor = element_blank(),
legend.position = "none"
) +
# 添加 AUC 数值标注
annotate("text", x = 0.5, y = 0.2,
label = paste("AUC =", round(auc, 3)),
size = 8, color = "#d95f02", fontface = "bold", alpha = 0.8)
print(p)
train_pred <- predict(res3, df[c("BIL", "Alb", "ALP", "ALT")])
pred_roc <- prediction(train_pred$posterior[, "Sick"], df$sick)
perf <- performance(pred_roc, "tpr", "fpr")
auc <- performance(pred_roc, "auc")@y.values[[1]]
roc_data <- data.frame(
FPR = perf@x.values[[1]],   # 假阳性率
TPR = perf@y.values[[1]]    # 真阳性率
)
p <- ggplot(roc_data, aes(x = FPR, y = TPR)) +
geom_line(color = "#007acc", linewidth = 1.2, alpha = 0.9) +
geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "yellow", alpha = 0.7) +
labs(
title = "ROC 曲线",
subtitle = paste("AUC =", round(auc, 3)),
x = "假阳性率",
y = "真阳性率"
) +
theme_minimal() +
theme(
plot.title = element_text(size = 16, face = "bold", color = "#222222"),
plot.subtitle = element_text(size = 12, face = "italic", color = "#555555"),
axis.title = element_text(size = 11),
axis.text = element_text(size = 10),
panel.grid.major = element_line(color = "red", linewidth = 0.5),
panel.grid.minor = element_blank(),
legend.position = "none"
) +
# 添加 AUC 数值标注
annotate("text", x = 0.5, y = 0.2,
label = paste("AUC =", round(auc, 3)),
size = 8, color = "#d95f02", fontface = "bold", alpha = 0.8)
print(p)
train_pred <- predict(res3, df[c("BIL", "Alb", "ALP", "ALT")])
pred_roc <- prediction(train_pred$posterior[, "Sick"], df$sick)
perf <- performance(pred_roc, "tpr", "fpr")
auc <- performance(pred_roc, "auc")@y.values[[1]]
roc_data <- data.frame(
FPR = perf@x.values[[1]],   # 假阳性率
TPR = perf@y.values[[1]]    # 真阳性率
)
p <- ggplot(roc_data, aes(x = FPR, y = TPR)) +
geom_line(color = "#007acc", linewidth = 1.2, alpha = 0.9) +
geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red", alpha = 0.7) +
labs(
title = "ROC 曲线",
subtitle = paste("AUC =", round(auc, 3)),
x = "假阳性率",
y = "真阳性率"
) +
theme_minimal() +
theme(
plot.title = element_text(size = 16, face = "bold", color = "#222222"),
plot.subtitle = element_text(size = 12, face = "italic", color = "#555555"),
axis.title = element_text(size = 11),
axis.text = element_text(size = 10),
panel.grid.major = element_line(color = "black", linewidth = 0.5),
panel.grid.minor = element_blank(),
legend.position = "none"
) +
# 添加 AUC 数值标注
annotate("text", x = 0.5, y = 0.2,
label = paste("AUC =", round(auc, 3)),
size = 8, color = "#d95f02", fontface = "bold", alpha = 0.8)
print(p)
df_plot <- df
df_plot$LD1 <- predict(res3, df[c("BIL", "Alb", "ALP", "ALT")])$x[, 1]
ggplot(df_plot, aes(x = LD1, fill = sick)) +
geom_density(alpha = 0.6) +
labs(title = "LDA 判别轴密度图",
x = "判别得分 (LD1)",
y = "密度") +
theme_minimal() +
scale_fill_brewer(palette = "Set1")
coef(res3)
test_data <- na.omit(data[,c("BIL", "Alb", "ALP", "ALT")])
res4 <- predict(res3,test_data)
print(res4$class)
prop.table(table(res4$class))
options(htmltools.dir.version = FALSE)
library(knitr)
opts_knit$set(eval.after = 'fig.cap')
library(tidyverse)
library(reshape2)
library(ggplot2)
library(readxl)
library(dplyr)
library(readr)
library(gtsummary)
library(mice)
library(Hmisc)
library(naniar)
library(corrplot)
library(ICSNP)
library(MVN)
library(knitr)
library(car)
library(MASS)
library(ROCR)
library(showtext)
showtext_auto()
means <- res3$means %>%
as.data.frame() %>%
tibble::rownames_to_column(var = "Variable") %>%
rename(Healthy = Healthy, Sick = Sick)
colnames(as.data.frame(res3$means))
res3$means
means <- res3$means %>%
as.data.frame() %>%
tibble::rownames_to_column(var = "Variable") %>%
rename(Healthy = Healthy, Sick = Sick)
means <- res3$means
means <- as.data.frame(means)
colnames(means) <- c("Healthy", "Sick")
means <- means %>%
tibble::rownames_to_column("Variable")
means <- res3$means
means <- as.data.frame(means)
# colnames(means) <- c("Healthy", "Sick")
# means <- means %>%
#   tibble::rownames_to_column("Variable")
# means <- res3$means %>%
#   as.data.frame() %>%
#   tibble::rownames_to_column(var = "Variable") %>%
#   rename(Healthy = Healthy, Sick = Sick)
coefs <- coef(res3) %>%
as.vector() %>%
setNames(NULL) %>%
data.frame(LD1 = .,
Variable = rownames(coef(res3))) %>%
select(Variable, LD1)
means <- res3$means
means <- as.data.frame(means)
colnames(means) <- c("Healthy", "Sick")
means <- means %>%
tibble::rownames_to_column("Variable")
colnames(res3$means)
means <- t(res3$means) %>%
as.data.frame() %>%
tibble::rownames_to_column(var = "Variable") %>%
rename(Healthy = Healthy, Sick = Sick)
coefs <- coef(res3) %>%
as.vector() %>%
setNames(NULL) %>%
data.frame(LD1 = .,
Variable = rownames(coef(res3))) %>%
select(Variable, LD1)
means <- t(res3$means) %>%
as.data.frame() %>%
tibble::rownames_to_column(var = "Variable") %>%
rename(Healthy = Healthy, Sick = Sick)
coefs <- coef(res3) %>%
as.vector() %>%
setNames(NULL) %>%
data.frame(LD1 = .,
Variable = rownames(coef(res3))) %>%
dplyr::select(Variable, LD1)
res <- means %>%
left_join(coefs, by = "Variable") %>%
mutate(
`Healthy` = round(Healthy, 2),
`Sick` = round(Sick, 2),
`LD1` = round(LD1, 6)
) %>%
dplyr::select(Variable, Healthy, Sick, Difference, LD1)
means <- t(res3$means) %>%
as.data.frame() %>%
tibble::rownames_to_column(var = "Variable") %>%
rename(Healthy = Healthy, Sick = Sick)
coefs <- coef(res3) %>%
as.vector() %>%
setNames(NULL) %>%
data.frame(LD1 = .,
Variable = rownames(coef(res3))) %>%
dplyr::select(Variable, LD1)
res <- means %>%
left_join(coefs, by = "Variable") %>%
mutate(
`Healthy` = round(Healthy, 2),
`Sick` = round(Sick, 2),
`LD1` = round(LD1, 6)
) %>%
dplyr::select(Variable, Healthy, Sick, LD1)
kable(res,
caption = "两组各指标的均值与线性判别系数",
col.names = c("变量", "健康组均值", "患者组均值","判别系数（LD1）"),
align = "c",
digits = 3)
means <- t(res3$means) %>%
as.data.frame() %>%
tibble::rownames_to_column(var = "Variable") %>%
rename(Healthy = Healthy, Sick = Sick)
coefs <- coef(res3) %>%
as.vector() %>%
setNames(NULL) %>%
data.frame(LD1 = .,
Variable = rownames(coef(res3))) %>%
dplyr::select(Variable, LD1)
res <- means %>%
left_join(coefs, by = "Variable") %>%
mutate(
`Healthy` = round(Healthy, 2),
`Sick` = round(Sick, 2),
`LD1` = round(LD1, 6)
) %>%
dplyr::select(Variable, Healthy, Sick, LD1)
kable(res,
caption = "两组各指标的均值与线性判别系数",
col.names = c("变量", "健康组均值", "患者组均值","判别系数"),
align = "c",
digits = 3)
means <- t(res3$means) %>%
as.data.frame() %>%
tibble::rownames_to_column(var = "Variable") %>%
rename(Healthy = Healthy, Sick = Sick)
coefs <- coef(res3) %>%
as.vector() %>%
setNames(NULL) %>%
data.frame(LD1 = .,
Variable = rownames(coef(res3))) %>%
dplyr::select(Variable, LD1)
res <- means %>%
left_join(coefs, by = "Variable") %>%
mutate(
`Healthy` = round(Healthy, 2),
`Sick` = round(Sick, 2),
`LD1` = round(LD1, 6)
) %>%
dplyr::select(Variable, Healthy, Sick, LD1)
kable(res,
caption = "两组各指标的均值与线性判别系数",
col.names = c("变量", "健康组均值", "患者组均值","判别系数"),
align = "c",
digits = 3)
tapply(df_plot$LD1, df$sick, mean)
